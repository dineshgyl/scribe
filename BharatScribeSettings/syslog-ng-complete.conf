#############################################################################
# syslog-ng.conf customized for scribe on Asuswrt-Merlin firmware
# compare to /opt/share/syslog-ng/examples/syslog-ng.conf-opkg for differences from Entware distribution
#
# syslog-ng documentation: https://www.syslog-ng.com/technical-documents/list/syslog-ng-open-source-edition
#
# Release notes: https://github.com/syslog-ng/syslog-ng/releases 

@version: 4.7
#@include "scl.conf" # uncomment this line to for additional functionality, see syslog-ng documentation
@include "/opt/etc/syslog-ng.d/" # Put any customization files in this directory
# send _ALL_ messages to a remote logging facility; it is recommended to set the remote log
# server here instead of in syslog-ng.conf if you are using this method to keep all remote
# information in one file - if you do set the log_server destination in syslog-ng.conf, 
# you will need to comment out the three lines here that define it
#
# it is strongly recommended to use IP addresess instead of hostnames for the destination
# server, as logging will stall if the nameserver is unavailable
#
# the following definition will send messages to a remote syslog-ng server in RFC 3164 (BSD / legacy) format
# RFC 3164 will be compatibile with a wider range of syslog servers

destination log_server { udp("10.0.0.16" port(514)); };

# the alternate definition below will send messages to a remote server in RFC 5424 (IETF) format,
# to use this format, comment out the above log_server definition and uncomment the one below
# for this defintion, the default transport protocol is tcp, and the default port is 601
# trasport protocal and port may be changed, and TLS encryption may be used; see the manual

#destination log_server { syslog("10.1.2.3"); };

log {
    source(src);
    destination(log_server);
};

# eof
# don't log empty messages from kernel

filter f_blank {
    program("kernel") and
    message("^ *$");
};

log {
    source(src);
    filter(f_blank);
    flags(final);
};

#eof
# grab dhcp messages from dnsmasq and log them

destination d_dhcp {
    file("/opt/var/log/dhcp.log");
};

filter f_dnsmasq-dhcp {
   ( program("dnsmasq-dhcp") );
};

# filter dhcp messages and write to dhcp.log
log {
   source(src);
   filter(f_dnsmasq-dhcp);
   destination(d_dhcp);
   flags(final);
};

#eof

# this filter is NOT compatible with the Skynet filter!
destination d_firewall { 
    file("/opt/var/log/firewall.log");
};

# log messages from firewall
filter f_firewall {
    message("ACCEPT IN=") or
    message("DROP IN=");
};

# final flag stops processing of messages matching the f_firewall filter
# only look to kernel for messages
log {
    source(src);
    filter(f_firewall);
    destination(d_firewall);
    flags(final);
};

#eof
# log all hostapd logs to /opt/var/log/hostapd.log and stop processing hostapd logs

destination d_hostapd {
   file("/opt/var/log/hostapd.log");
};

filter f_hostapd {
   program("hostapd");
};

log {
   source(src);
   filter(f_hostapd);
   destination(d_hostapd);
   flags(final);
};

#eof
# gather logrotate logs together for unified log

destination d_logrotate { 
    file("/opt/var/log/logrotate.log");
};

source s_lr_status {
    file("/var/lib/logrotate.status" program-override("logrotate") flags(no-parse));
};

source s_lr_daily {
    file("/opt/tmp/logrotate.daily" program-override("logrotate") flags(no-parse));
};

log {
    source(s_lr_status);
    source(s_lr_daily);
    destination(d_logrotate);
    flags(final);
};

#eof
# put syslog-ng's logging stats into /opt/var/log/syslog-ng.log

destination d_syslogng { 
    file("/opt/var/log/syslog-ng.log");
};

filter f_syslogng {
    program("syslog-ng")
};

log {
    source(src);
    filter(f_syslogng);
    destination(d_syslogng);
    flags(final);
};

#eof
# put wlceventd Assoc/ReAssoc/Disassoc messages into /opt/var/log/wlceventd.log

destination d_wlceventd { 
    file("/opt/var/log/wlceventd.log");
};

filter f_wlceventd {
    ( ( program("WLCEVENTD") or
    program("wlceventd") ) and
    ( message("ssoc") or
    message("uth") ) ) or
    ( program("syslog") and
    message("wlceventd") );
};

log {
    source(src);
    filter(f_wlceventd);
    destination(d_wlceventd);
    flags(final);
};

#eof

options {
    chain_hostnames(no); # Enable or disable the chained hostname format.
    create_dirs(yes);
    keep_hostname(yes); # Enable or disable hostname rewriting.
    log_fifo_size(256); # The number of messages that the output queue can store.
    log_msg_size(16384); # Maximum length of a message in bytes.
    stats(freq(21600)); # The period between two STATS messages sent by syslog-ng, containing statistics about dropped logs in seconds; 0 disables. (21,600 seconds = 6 hours)
    flush_lines(0); # How many lines are flushed to a destination at a time.
    use_fqdn(no); # Add Fully Qualified Domain Name instead of short hostname.
};

# syslog-ng gets messages from the system, kernel, and syslog-ng (internal)
# DO NOT use system() source; causes issues on HND routers
# so_rcvbuf = maximum number of messages per second * 1024
source src {
    unix-dgram("/dev/log" so_rcvbuf(65536) flags(syslog-protocol));
    file("/proc/kmsg" program_override("kernel") flags(kernel));
    internal();
#    udp(ip(192.168.x.y) port(514)); # uncomment this line to pass all network messages through syslog-ng filters
};

# if you only want to pass network messages through some syslog-ng filters, uncomment the source line below
# then add "source(net);" to the log statement in any filter you want to pass network messages through
#source net { udp(ip(192.168.x.y) port(514)); };

# set the filename for the default log file - anything not filtered out will end up here
destination messages { file("/opt/var/log/messages"); };

# to send log messages to the local network, uncomment the destination line below
# then add "destination(log_server);" to the log statement in any filter you want to pass network messages through
#destination log_server { udp("192.168.x.y" port(514)); };

log {
    source(src);
#    source(net); # uncomment this and "source net" function above to get udp log messages from local network
    destination(messages);
#    destination(log_server); # uncomment this and "destination log_server" function above to send udp log messages to local network
};
